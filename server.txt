using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using ABB.Robotics.RobotStudio;
using ABB.Robotics.RobotStudio.Environment;
using ABB.Robotics.RobotStudio.Stations;

namespace ChatGBTAddIn
{
    public class Class1 : HostedAddInBase
    {
        private static readonly string apiKey = Environment.GetEnvironmentVariable("chatgpt_api");
        private static readonly string apiEndpoint = Environment.GetEnvironmentVariable("chatgpt_endpoint");

        // This is the entry point which will be called when the Add-in is loaded
        static async Task<string> HelpTask(String info)
        {
            using (HttpClient client = new HttpClient())
            {
                client.DefaultRequestHeaders.Add("api-key", apiKey);
                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                var data = new
                {
                    model = "gpt-4o",
                    messages = new[]
                    {
                    new { role = "user", content = info }
                    }
                };

                string jsonData = JsonSerializer.Serialize(data);
                var content = new StringContent(jsonData, Encoding.UTF8, "application/json");

                try
                {
                    HttpResponseMessage response = await client.PostAsync(apiEndpoint, content);
                    response.EnsureSuccessStatusCode();
                    string result = await response.Content.ReadAsStringAsync();

                    using (JsonDocument doc = JsonDocument.Parse(result))
                    {
                        return doc.RootElement
                                  .GetProperty("choices")[0]
                                  .GetProperty("message")
                                  .GetProperty("content")
                                  .GetString()
                                  .Trim();
                    }
                }
                catch (Exception ex)
                {
                    return $"An error occurred: {ex.Message}";
                }
            }
        }

        static async Task AddinMain(string[] args)
        {
            for (int i = 0; i < 3; i++)
            {
                Console.Write("User: ");
                string question = Console.ReadLine();

                if (question.ToLower() == "exit")
                {
                    Console.WriteLine("\nThank you for using RobotStudio Assistant! Have a nice day!");
                    break;
                }

                string robotstudioPrompt = $@"
                Your role is a virtual assistant that helps new beginner users navigate ABB Robot Studio, specifically Offline Programming. 
                - As a virtual assistant, you should be concise and clear as possible. Using common terms and easy to follow and understand as if you were talking to a completely new user that has a hard time understanding information.   
                - You should only give responses pertaining to ABB Robot Studio, never give responses that not pertaining to ABB Robot Studio.    
                - As a Virtual Assistant you are to use these manuals as a tool to help new beginner users navigate and answer questions. 
                - IF ASSIGNED, ALWAYS GIVE RESPONSES BASED ON THE ROBOT MODEL AND ROBOTWARE ASSIGNED. 
                These are the commands you shall follow:    
                When users ask to locate something in RobotStudio, you will act as a navigation assistant for ABB RobotStudio and provide precise, direct, and concise step-by-step bullet point instructions to help users navigate effectively within the software. Ensure the instructions are easy to follow for beginners. Examples are like 'where is operation mode' and 'help me find the FlexPendant.' 
                When a user asks you to explain something in Robot Studio, you will act as a virtual assistant for beginners by providing a concise and clear explanation of the topic at hand, ensuring that it is easy to understand for someone who struggles with complex information. Use simple language, relatable examples, and avoid jargon to make the explanation as accessible as possible. Examples are like 'explain RAPID Module file' and 'what is Manual Mode' 

                {question}
            ";

                string response = await HelpTask(robotstudioPrompt);
                Console.WriteLine("Assist: " + response);
            }
        }
    }
}



//// Original Code
import express from "express";
import bodyParser from "body-parser";
import dotenv from "dotenv";
import OpenAI from "openai";
import cors from "cors";

dotenv.config();

const app = express();
app.use(cors());
app.use(bodyParser.json());

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

console.log("API Key prefix:", process.env.OPENAI_API_KEY?.slice(0, 10));

app.post("/chatgpt", async (req, res) => {
  const { prompt } = req.body;
  console.log("âž¡ï¸ User prompt:", prompt);

  try {
    const completion = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `
            You are an interpreter that translates natural language instructions into robot commands.

            Always output a **valid JSON object only**, never text outside JSON.
            Format:

            {
            "commands": [
                { "action": "move", "direction": "forward", "steps": 2 },
                { "action": "rotate", "direction": "right" },
                { "action": "pick" },
                { "action": "release" }
            ]
            }
            `
        },
        { role: "user", content: prompt }
      ],
      temperature: 0
    });

    let reply = completion.choices[0].message.content.trim();
    console.log("â¬…ï¸ Raw ChatGPT reply:", reply);

    try {
      const jsonReply = JSON.parse(reply);
      res.json(jsonReply);
    } catch (parseErr) {
      console.error("âŒ Parse error:", parseErr);
      res.json({ commands: [] });
    }
  } catch (err) {
    console.error("âŒ ChatGPT error:", err);
    res.status(500).json({ error: err.message });
  }
});

app.listen(3000, () => {
  console.log("ðŸš€ Chat server running on http://localhost:3000");
});
